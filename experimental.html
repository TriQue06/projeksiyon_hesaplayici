<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seçim Senaryo Simülatörü — Pro</title>
  <style>
    :root {
      --bg: #f0f2f5;
      --card: #ffffff;
      --muted: #64748b;
      --accent: #0f172a;
      --primary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    @font-face {
      font-family: 'ProductSans';
      src: local('Arial'); /* Sistem fontu yedeği */
      font-weight: 700;
    }

    body {
      margin: 0; background: var(--bg); color: var(--accent);
      font-family: 'Inter', 'ProductSans', -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    header { margin-bottom: 30px; border-bottom: 2px solid var(--border); padding-bottom: 20px; }
    h1 { margin: 0; font-size: 28px; letter-spacing: -0.5px; }
    .subtitle { color: var(--muted); margin-top: 5px; font-size: 14px; }

    .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }

    .card {
      background: var(--card); border-radius: 16px; padding: 20px;
      box-shadow: var(--shadow); border: 1px solid var(--border);
    }

    .card label { display: block; font-weight: 700; margin-bottom: 12px; font-size: 14px; color: var(--accent); }

    /* Inputs & Buttons */
    input[type=file] { font-size: 12px; color: var(--muted); margin-top: 5px; }
    input[type=text], input[type=number] {
      padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border);
      font-family: inherit; font-size: 14px; width: 100%; box-sizing: border-box; outline: none; transition: 0.2s;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

    .btn {
      padding: 10px 18px; border-radius: 10px; border: none; font-weight: 700;
      cursor: pointer; font-family: inherit; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; font-size: 11px; padding: 4px 8px; }
    .btn-outline { background: white; border: 1px solid var(--border); color: var(--accent); }

    /* Parties Flow */
    .parties { display: flex; flex-wrap: wrap; gap: 8px; }
    .party-chip {
      background: #f8fafc; border: 1px solid var(--border); padding: 8px 12px;
      border-radius: 10px; display: flex; align-items: center; gap: 8px; font-size: 13px;
    }
    .party-chip input { width: 55px !important; padding: 4px !important; text-align: center; }

    /* Simulation Results */
    #districts { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .district-card {
      background: white; border-radius: 16px; padding: 18px; box-shadow: var(--shadow);
      border-top: 4px solid var(--primary);
    }
    .district-card h3 { margin: 0 0 15px 0; font-size: 18px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

    .party-line {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid #f8fafc; font-size: 13px;
    }
    .party-line:last-child { border-bottom: none; }
    .mv-badge {
      background: var(--accent); color: white; padding: 2px 8px;
      border-radius: 6px; font-weight: bold; font-size: 12px; margin-left: 8px;
    }
    .coalition-text { color: var(--primary); font-weight: bold; }

    .import-label {
      padding: 10px 18px; border-radius: 10px; border: 2px dashed var(--border);
      background: white; cursor: pointer; font-weight: bold; font-size: 13px; display: inline-block;
    }

    .flex-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .small-note { font-size: 11px; color: var(--muted); margin-top: 8px; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Seçim Senaryo Simülatörü <span style="color:var(--primary)">Pro</span></h1>
    <div class="subtitle">2023/2024 Verileri ve Hibrit D'Hondt Projeksiyonu</div>
  </header>

  <div class="grid-inputs">
    <div class="card">
      <label>1) Veri Setlerini Yükle</label>
      <div style="margin-bottom:15px">
        <span class="small-note">2023 Milletvekili (.txt)</span>
        <input id="file2023" type="file" accept=".txt">
      </div>
      <div>
        <span class="small-note">2024 İl Genel Meclisi (.txt)</span>
        <input id="file2024" type="file" accept=".txt">
      </div>
      <div id="fileInfo" class="small-note" style="margin-top:10px; color:var(--success); font-weight:bold;"></div>
    </div>

    <div class="card">
      <label>2) Ülke Geneli Hedef Oy Oranları (%)</label>
      <div id="partiesContainer" class="parties"></div>
    </div>

    <div class="card">
      <label>3) Yeni Parti Tanımla</label>
      <div class="flex-group">
        <input id="newPartyName" placeholder="Parti Adı" style="flex:2">
        <input id="newPartyNat" placeholder="Ülke %" style="flex:1">
        <button id="addNewParty" class="btn btn-primary">Ekle</button>
      </div>
      <div id="newPartyDonors" class="parties" style="margin-top:15px"></div>
      <div class="small-note">Benzerlik toplamı %100 olmalıdır.</div>
    </div>

    <div class="card">
      <label>4) Ortak Liste / İttifak Tanımları</label>
      <div class="flex-group">
        <input id="coalitionName" placeholder="İttifak/Liste Adı" style="flex:2">
        <button id="addCoalition" class="btn btn-primary">Liste Oluştur</button>
      </div>
      <div id="coalitionArea" class="parties" style="margin-top:15px"></div>
    </div>

    <div class="card">
      <label>5) Dönem Ağırlık Katsayıları</label>
      <div class="flex-group">
        <div class="party-chip">2023: <input id="w23" type="number" step="0.05" value="0.6"></div>
        <div class="party-chip">2024: <input id="w24" type="number" step="0.05" value="0.4"></div>
      </div>
    </div>
  </div>

  <div class="card flex-group" style="justify-content: center; gap: 20px; border: 2px solid var(--primary);">
    <button id="run" class="btn btn-primary" style="padding:15px 40px; font-size:16px;">HESAPLA VE PROJEKSİYON ÜRET</button>
    <button id="downloadTxt" class="btn btn-outline">Sonuçları İndir (.txt)</button>
    <button id="downloadProjection" class="btn btn-outline">Projeksiyonu Kaydet (.json)</button>
    <label class="import-label">
      <input id="uploadProjection" type="file" accept=".json" style="display:none">
      Projeksiyon Yükle (.json)
    </label>
  </div>

  <div id="districts" style="margin-top:30px"></div>
</div>

<script>
// === HESAPLAMA MANTIGI (KORUNMUŞTUR) ===
const file2023=document.getElementById('file2023');
const file2024=document.getElementById('file2024');
const fileInfo=document.getElementById('fileInfo');
const partiesContainer=document.getElementById('partiesContainer');
const districtsEl=document.getElementById('districts');
const runBtn=document.getElementById('run');
const downloadBtn=document.getElementById('downloadTxt');
const newPartyName=document.getElementById('newPartyName');
const newPartyNat=document.getElementById('newPartyNat');
const addNewPartyBtn=document.getElementById('addNewParty');
const newPartyDonors=document.getElementById('newPartyDonors');
const coalitionNameEl=document.getElementById('coalitionName');
const addCoalitionBtn=document.getElementById('addCoalition');
const coalitionArea=document.getElementById('coalitionArea');
const w23El=document.getElementById('w23');
const w24El=document.getElementById('w24');
const downloadProjectionBtn=document.getElementById('downloadProjection');
const uploadProjectionInput=document.getElementById('uploadProjection');

let data2023=null,data2024=null,rawTxt2023=null, rawTxt2024=null,baseParties={},extraParty=null,coalitions=[],simulatedResults={};

function readFile(input){return new Promise(res=>{const f=input.files[0];if(!f)return res(null);const r=new FileReader();r.onload=()=>res(r.result);r.readAsText(f,'utf-8');});}

function parseTxt(txt){
 const blocks=txt.split(/\n-\s*\n|\n\n+/).map(b=>b.trim()).filter(Boolean);
 const out={};
 blocks.forEach(b=>{
  const lines=b.split(/\n/).map(l=>l.trim()).filter(Boolean);
  let name=lines[0],seats=0;
  const m=name.match(/^(.*?)-(\s*\d+)$/);
  if(m){name=m[1].trim();seats=parseInt(m[2]);}
  const votes={};
  lines.slice(1).forEach(l=>{
   const p=l.split(/\s+/);
   for(let i=0;i<p.length-1;i++){
    if(/^[^0-9]+$/.test(p[i])){
     const n=p[i+1].replace(/\.|,/g,'');
     if(/^\d+$/.test(n)){votes[p[i]]=(votes[p[i]]||0)+parseInt(n);i++;}
    }
   }
  });
  out[name.toUpperCase()]={votes,seats};
 });
 return out;
}
function computeNational(blocks){
 const t={};let g=0;
 for(const d in blocks){for(const p in blocks[d].votes){t[p]=(t[p]||0)+blocks[d].votes[p];g+=blocks[d].votes[p];}}
 return{t,g};
}
function getProv(d){return d.split(/\s+/)[0];}
function dhondt(votes,seats){const res={};Object.keys(votes).forEach(p=>res[p]=0);for(let i=0;i<seats;i++){let bp=null,bq=-1;for(const p in votes){const q=votes[p]/(res[p]+1);if(q>bq){bq=q;bp=p;}}if(bp)res[bp]++;}return res;}

file2023.onchange=async()=>{const t=await readFile(file2023);if(!t)return;rawTxt2023=t;data2023=parseTxt(t);updatePartyInputs();fileInfo.textContent=`${Object.keys(data2023).length} Seçim Çevresi Hazır`;};
file2024.onchange=async()=>{const t=await readFile(file2024);if(!t)return;rawTxt2024=t;data2024=parseTxt(t);updatePartyInputs();};

function updatePartyInputs(){
 if(!data2023||!data2024)return;
 partiesContainer.innerHTML='';
 const set=new Set();
 Object.values(data2023).forEach(d=>Object.keys(d.votes).forEach(p=>set.add(p)));
 Object.values(data2024).forEach(d=>Object.keys(d.votes).forEach(p=>set.add(p)));
 Array.from(set).sort().forEach(p=>{
  const div=document.createElement('div');
  div.className='party-chip';
  div.innerHTML=`<b>${p}</b> <input data-p="${p}" placeholder="0"> %`;
  partiesContainer.appendChild(div);
 });
 Object.keys(baseParties).forEach(p=>{const i=partiesContainer.querySelector(`input[data-p="${p}"]`);if(i)i.value=baseParties[p];});
}

addNewPartyBtn.onclick=()=>{
 const name=newPartyName.value.trim().toUpperCase();
 const nat=parseFloat(newPartyNat.value.replace(',','.'))||0;
 if(!name||nat<=0){alert('Geçerli parti adı ve ülke payı girin');return;}
 extraParty={name,nat,similarity:{}};
 newPartyDonors.innerHTML='';
 partiesContainer.querySelectorAll('input').forEach(i=>{
  const p=i.dataset.p;
  const d=document.createElement('div');
  d.className='party-chip';
  d.innerHTML=`${p}: <input data-p="${p}"> %`;
  newPartyDonors.appendChild(d);
 });
};

addCoalitionBtn.onclick=()=>{
 const name=coalitionNameEl.value.trim();if(!name)return;
 const c={name,members:[]};
 const wrap=document.createElement('div');wrap.className='card';
 wrap.style.minWidth="180px";
 const title=document.createElement('div');title.innerHTML=`<b>${name}</b> `;
 const rm=document.createElement('button');rm.textContent='X';rm.className='btn btn-danger';rm.style.marginLeft="10px";
 rm.onclick=()=>{coalitions=coalitions.filter(x=>x!==c);wrap.remove();};
 title.appendChild(rm);wrap.appendChild(title);
 partiesContainer.querySelectorAll('input').forEach(i=>{
  const p=i.dataset.p;
  const lbl=document.createElement('label');lbl.style.display='block';lbl.style.fontWeight="normal";lbl.style.marginTop="5px";
  lbl.innerHTML=`<input type="checkbox" value="${p}"> ${p}`;
  lbl.querySelector('input').onchange=e=>{if(e.target.checked)c.members.push(p);else c.members=c.members.filter(x=>x!==p);};
  wrap.appendChild(lbl);
 });
 coalitionArea.appendChild(wrap);coalitions.push(c);
};

runBtn.onclick=()=>{
 if(!data2023||!data2024){alert('Dosyaları yükle');return;}
 simulatedResults={};
 baseParties={};
 partiesContainer.querySelectorAll('input').forEach(i=>{baseParties[i.dataset.p]=parseFloat(i.value.replace(',','.'))||0;});
 if(extraParty){
  extraParty.nat=parseFloat(newPartyNat.value.replace(',','.'))||extraParty.nat;
  extraParty.similarity={};
  newPartyDonors.querySelectorAll('input').forEach(i=>{const v=parseFloat(i.value.replace(',','.'))||0;if(v>0)extraParty.similarity[i.dataset.p]=v/100;});
 }
 let w23=parseFloat(w23El.value)||0.6;let w24=parseFloat(w24El.value)||0.4;const ws=w23+w24||1;w23/=ws;w24/=ws;
 const nat23=computeNational(data2023),nat24=computeNational(data2024);
 const pct23={},pct24={};for(const p in nat23.t)pct23[p]=nat23.t[p]/nat23.g*100;for(const p in nat24.t)pct24[p]=nat24.t[p]/nat24.g*100;
 const provIndex={};Object.keys(data2024).forEach(k=>provIndex[k]=data2024[k].votes);
 districtsEl.innerHTML='<div style="grid-column: 1/-1; text-align: center;">Hesaplanıyor...</div>';
 setTimeout(() => {
    Object.keys(data2023).forEach(d=>{
      const prov=getProv(d);const pv=provIndex[prov];const dv=data2023[d].votes;const tot=Object.values(dv).reduce((a,b)=>a+b,0)||1;
      let raw={},sum=0;
      for(const p in baseParties){
      const d23=(dv[p]||0)/tot*100;const s23=d23/(pct23[p]||d23||1);let s24=s23;
      if(pv){const pt=Object.values(pv).reduce((a,b)=>a+b,0)||1;const pp=(pv[p]||0)/pt*100;s24=pp/(pct24[p]||pp||1);}const fs=w23*s23+w24*s24;const ap=baseParties[p]*fs;raw[p]=ap;sum+=ap;
      }
      if(extraParty){
      let s23=0,s24=0;
      for(const sp in extraParty.similarity){
        const w=extraParty.similarity[sp];const d23=(dv[sp]||0)/tot*100;const sp23=d23/(pct23[sp]||d23||1);let sp24=sp23;
        if(pv){const pt=Object.values(pv).reduce((a,b)=>a+b,0)||1;const pp=(pv[sp]||0)/pt*100;sp24=pp/(pct24[sp]||pp||1);}s23+=w*sp23;s24+=w*sp24;
      }
      const fs=w23*s23+w24*s24;const ap=extraParty.nat*fs;raw[extraParty.name]=ap;sum+=ap;
      }
      const norm={};Object.keys(raw).forEach(p=>norm[p]=raw[p]/sum*100);
      const votes={};Object.keys(norm).forEach(p=>votes[p]=Math.round(norm[p]/100*tot));
      simulatedResults[d]={seats:data2023[d].seats||0,votes:{...votes}};
    });
    renderSimulatedResults();
 }, 100);
};

function renderSimulatedResults(){
 districtsEl.innerHTML='';
 Object.keys(simulatedResults).forEach(d=>{
  const r=simulatedResults[d];const votes={...r.votes};const tot=Object.values(votes).reduce((a,b)=>a+b,0)||1;
  let dhVotes={...votes};coalitions.forEach(c=>{if(c.members.length>=2){let comb=0;c.members.forEach(p=>{if(dhVotes[p]!=null){comb+=dhVotes[p];delete dhVotes[p];}});dhVotes[c.name]=comb;}});
  const mv=r.seats?dhondt(dhVotes,r.seats):{};
  const card=document.createElement('div');card.className='district-card';card.innerHTML=`<h3>${d}</h3>`;
  coalitions.forEach(c=>{const tv=c.members.reduce((a,p)=>a+(r.votes[p]||0),0);const pct=(tv/tot*100).toFixed(2);const line=document.createElement('div');line.className='party-line coalition-line';line.innerHTML=`<span class="coalition-text">${c.name}</span><span>${tv.toLocaleString()} (%${pct})<span class="mv-badge">${mv[c.name]||0} MV</span></span>`;card.appendChild(line);});
  Object.keys(r.votes).sort((a,b)=>r.votes[b]-r.votes[a]).forEach(p=>{if(coalitions.some(c=>c.members.includes(p)))return;const line=document.createElement('div');line.className='party-line';line.innerHTML=`<span>${p}</span><span>${r.votes[p].toLocaleString()} (%${(r.votes[p]/tot*100).toFixed(2)})<span class="mv-badge" style="${mv[p] ? '' : 'background:#e2e8f0;color:#94a3b8'}">${mv[p]||0} MV</span></span>`;card.appendChild(line);});
  districtsEl.appendChild(card);
 });
}

downloadBtn.onclick=()=>{
 if(!Object.keys(simulatedResults).length){alert('Önce hesapla');return;}
 let txt='';
 Object.keys(simulatedResults).forEach(d=>{
  const r = simulatedResults[d];
  let exportVotes = {...r.votes};
  coalitions.forEach(c=>{
   if(!c.members || c.members.length < 2) return;
   let combined = 0;
   c.members.forEach(p=>{if(exportVotes[p] != null){combined += exportVotes[p];delete exportVotes[p];}});
   exportVotes[c.name] = combined;
  });
  txt += `${d} - ${r.seats}\n`;
  Object.keys(exportVotes).forEach(p=>{txt += `${p} ${exportVotes[p]}\n`;});
  txt += '\n-\n\n';
 });
 const blob = new Blob([txt],{type:'text/plain;charset=utf-8;'});
 const a = document.createElement('a');
 a.href = URL.createObjectURL(blob);
 a.download = 'simulasyon_sonuclari.txt';
 a.click();
 URL.revokeObjectURL(a.href);
};

downloadProjectionBtn.onclick=()=>{
 if(!Object.keys(simulatedResults).length){alert('Önce hesapla');return;}
 const proj={meta:{generatedAt:new Date().toISOString()},baseParties,extraParty,coalitions,weights:{w23:w23El.value,w24:w24El.value},simulatedResults,rawTxt2023,rawTxt2024};
 const blob=new Blob([JSON.stringify(proj,null,2)],{type:'application/json;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='projeksiyon_simulation.json';a.click();URL.revokeObjectURL(a.href);
};

uploadProjectionInput.onchange=async()=>{const t=await readFile(uploadProjectionInput);if(!t)return;let proj;try{proj=JSON.parse(t);}catch{alert('Geçersiz JSON');return;}baseParties=proj.baseParties||{};extraParty=proj.extraParty||null;coalitions=proj.coalitions||[];simulatedResults=proj.simulatedResults||{};if(proj.weights){w23El.value=proj.weights.w23;w24El.value=proj.weights.w24;}updatePartyInputs();if(extraParty){newPartyName.value=extraParty.name;newPartyNat.value=extraParty.nat;newPartyDonors.innerHTML='';partiesContainer.querySelectorAll('input').forEach(i=>{const p=i.dataset.p;const d=document.createElement('div');d.className='party-chip';d.innerHTML=`${p}: <input data-p="${p}"> %`;const inp=d.querySelector('input');if(extraParty.similarity[p])inp.value=extraParty.similarity[p]*100;newPartyDonors.appendChild(d);});}renderSimulatedResults();alert('Projeksiyon başarıyla yüklendi!');};
</script>
</body>
</html>