<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Se√ßim Sim√ºlat√∂r√º Pro v5.1 - Final Patch</title>
    <style>
        :root{--primary:#0071e3;--bg:#f2f2f7;--card:#ffffff;--text:#1d1d1f;--border:#d2d2d7;--accent:#34c759;--danger:#ff3b30}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:15px;font-size:12px}
        
        /* Sidebar Temizliƒüi */
        .sidebar::-webkit-scrollbar { display: none; }
        .sidebar { -ms-overflow-style: none; scrollbar-width: none; }

        .container{max-width:1650px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:20px}
        h1{font-size:20px;font-weight:600;grid-column:1/-1;margin:0 0 15px; display:flex; align-items:center; gap:10px}
        .card{background:var(--card);border-radius:12px;padding:15px;box-shadow:0 1px 4px rgba(0,0,0,.05);border:1px solid var(--border);margin-bottom:15px}
        .sidebar{height:calc(100vh - 40px);overflow-y:auto;padding-right:5px}
        
        label{display:block;font-weight:600;margin-bottom:6px;color:#333}
        input, button, select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;box-sizing:border-box;font-size:12px}
        button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;transition:0.2s}
        button:hover{opacity:0.9}
        button.danger{background:var(--danger)}

        .data-row{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #eee}
        .parties-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(85px, 1fr));gap:6px}
        .party-box{background:#fff;border:1px solid var(--border);padding:6px;border-radius:6px;text-align:center}
        
        /* Benzerlik Alanƒ± Geni≈ületildi */
        .similarity-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(110px, 1fr));gap:8px;margin-top:10px}
        .sim-input-box{background:#eff4f9;padding:8px;border-radius:6px;border:1px solid #d1d9e0}

        /* 4'l√º Izgara G√∂r√ºn√ºm√º */
        #results{display:grid;grid-template-columns:repeat(auto-fill, minmax(calc(25% - 15px), 1fr));gap:15px}
        .dist-card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);border-top:4px solid var(--primary)}
        .dist-card h3{margin:0 0 10px;font-size:13px;display:flex;justify-content:space-between;color:var(--primary)}
        
        .p-line{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f0f0f0;align-items:center}
        .p-line.is-coal{color:var(--primary);font-weight:bold;background:#f0f7ff;margin:2px -5px;padding:5px;border-radius:4px}
        .mv-tag{background:var(--text);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:bold;margin-left:5px}
        
        /* ƒ∞ttifak Listesi Fix */
        .coal-member-label { display: flex; align-items: center; gap: 8px; font-weight: 400; margin-bottom: 5px; cursor: pointer; padding: 2px 0;}
        .coal-member-label input { width: 16px; height: 16px; margin: 0; cursor: pointer; }

        .flex-row{display:flex;gap:8px;align-items:center}
        .scroll-area{max-height:250px;overflow-y:auto;padding-right:5px; border:1px solid #eee; border-radius:8px; padding:5px; background:#fafafa}
    </style>
</head>
<body>

<h1>üó≥Ô∏è Se√ßim Sim√ºlat√∂r√º Pro v5.1 <small style="font-weight:400; font-size:12px; color:#666">| Superior Patch & 4-Column</small></h1>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <label>1. Veri Setleri (.txt)</label>
            <input type="file" id="fileInp" accept=".txt" multiple>
            <div id="datasetsList" class="scroll-area"></div>
        </div>

        <div class="card">
            <label>2. Hedef √úlke Oy Oranlarƒ± (%)</label>
            <div id="basePartiesArea" class="parties-grid"></div>
        </div>

        <div class="card">
            <label>3. Yeni Parti Ekle</label>
            <div class="flex-row">
                <input id="newPName" placeholder="Ad">
                <input id="newPNat" type="number" placeholder="%" style="width:70px">
                <button onclick="addExtraParty()" style="width:50px">+</button>
            </div>
            <div id="extraPartiesArea"></div>
        </div>

        <div class="card">
            <label>4. Ortak Listeler (ƒ∞ttifak)</label>
            <div class="flex-row">
                <input id="coalName" placeholder="Liste Adƒ±">
                <button onclick="addCoalition()" style="width:50px">+</button>
            </div>
            <div id="coalitionArea" class="scroll-area"></div>
        </div>

        <div class="card" style="position: sticky; bottom: 0; background: #fff; z-index: 10; padding-top: 10px; border-top: 2px solid var(--primary);">
            <button id="runBtn" style="background:var(--accent); font-size:15px; padding:16px">üöÄ HESAPLA</button>
            <button onclick="downloadResults()" class="danger" style="margin-top:8px">üíæ SONU√áLARI ƒ∞NDƒ∞R (.TXT)</button>
        </div>
    </div>

    <div id="results">
        <div style="grid-column:1/-1; color:#888; text-align:center; padding:100px; font-size:14px">
            Se√ßim sonu√ßlarƒ±nƒ± g√∂rmek i√ßin veri setlerini y√ºkleyin ve hesapla butonuna basƒ±n.
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let datasets = [];
let extraParties = [];
let coalitions = [];
let globalParties = new Set();

// Veri Okuma ve Ayrƒ±≈ütƒ±rma (Geli≈ütirilmi≈ü)
$('fileInp').onchange = async (e) => {
    for(let file of e.target.files){
        const text = await file.text();
        const data = parseTxt(text);
        const nat = calcNat(data);
        datasets.push({ id:Date.now()+Math.random(), name:file.name, data, nat, w:1.0 });
    }
    updateGlobalParties();
    renderDatasets();
};

function parseTxt(t){
    const out = {};
    t.split(/\n-\s*\n|\n\n+/).forEach(block => {
        const lines = block.trim().split('\n');
        if(lines.length < 2) return;
        
        // Geli≈ümi≈ü isim-koltuk ayrƒ±mƒ±: En sondaki tireden sonrasƒ±nƒ± sayƒ± al
        let header = lines[0].trim();
        let parts = header.split('-');
        let seats = parseInt(parts.pop()) || 0;
        let name = parts.join('-').trim().toUpperCase();
        
        const votes = {};
        lines.slice(1).forEach(l => {
            const p = l.split(/\s+/);
            const v = parseInt(p.pop().replace(/\D/g,''));
            if(!isNaN(v)) votes[p.join(' ').toUpperCase()] = v;
        });
        out[name] = { votes, seats };
    });
    return out;
}

function calcNat(data){
    let total = 0, sums = {};
    for(let d in data){
        for(let p in data[d].votes){
            sums[p] = (sums[p]||0) + data[d].votes[p];
            total += data[d].votes[p];
        }
    }
    for(let p in sums) sums[p] /= (total || 1);
    return sums;
}

// Master District Logic (Fix: ƒ∞stanbul/ƒ∞stanbul-1 √áakƒ±≈ümasƒ± Engellendi)
function getMasterDistricts() {
    const allDNames = new Set();
    datasets.forEach(ds => {
        Object.keys(ds.data).forEach(n => {
            // Sadece MV sayƒ±sƒ± > 0 olanlarƒ± veya en az bir yerde MV'si olanlarƒ± baz al
            if(ds.data[n].seats > 0) allDNames.add(n);
        });
    });
    
    const names = Array.from(allDNames);
    const parentsWithChildren = new Set();
    
    // Eƒüer listede "ƒ∞STANBUL-1" varsa, "ƒ∞STANBUL" ismini ebeveyn olarak i≈üaretle
    names.forEach(n => {
        if(n.includes('-')) {
            const parentName = n.split('-')[0].trim();
            parentsWithChildren.add(parentName);
        }
    });
    
    // Ebeveyn olanlarƒ± (√ñrn: Sadece "ƒ∞STANBUL") ana listeden temizle
    return names.filter(n => !parentsWithChildren.has(n));
}

function getDistrictDataWithPatch(dataset, targetName) {
    if(dataset.data[targetName]) return dataset.data[targetName];
    // Patch: ƒ∞STANBUL-1 bulunamadƒ±ysa ƒ∞STANBUL ana verisini kullan
    const root = targetName.split('-')[0].trim();
    if(dataset.data[root]) return dataset.data[root];
    return null;
}

function updateGlobalParties(){
    datasets.forEach(ds => Object.keys(ds.nat).forEach(p => globalParties.add(p)));
    renderBaseInputs();
}

function renderDatasets(){
    $('datasetsList').innerHTML = datasets.map(ds => `
        <div class="data-row flex-row">
            <span style="flex:1; overflow:hidden; font-size:11px"><b>${ds.name}</b></span>
            <div style="display:flex; align-items:center; gap:3px">
                W:<input type="number" step="0.1" value="${ds.w}" class="ds-weight-input" data-id="${ds.id}" style="width:40px; margin:0">
            </div>
            <button class="danger" onclick="datasets=datasets.filter(x=>x.id!=${ds.id});renderDatasets();" style="width:22px; margin:0; padding:2px">x</button>
        </div>
    `).join('');
}

function renderBaseInputs(){
    const area = $('basePartiesArea');
    const oldVals = {}; 
    area.querySelectorAll('input').forEach(i => oldVals[i.dataset.p] = i.value);
    area.innerHTML = [...globalParties].sort().map(p => `
        <div class="party-box">
            <span>${p}</span>
            <input data-p="${p}" type="number" step="0.1" value="${oldVals[p]||0}">
        </div>
    `).join('');
}

function addExtraParty(){
    const name = $('newPName').value.trim().toUpperCase();
    const nat = parseFloat($('newPNat').value)||0;
    if(!name) return;
    extraParties.push({ name, nat, similarity:{} });
    renderExtraParties();
}

function renderExtraParties(){
    $('extraPartiesArea').innerHTML = extraParties.map((ep, idx) => `
        <div class="data-row">
            <div class="flex-row"><b>${ep.name}</b> (%${ep.nat}) <button class="danger" onclick="extraParties.splice(${idx},1);renderExtraParties();" style="width:25px; margin-left:auto">x</button></div>
            <div class="similarity-grid">
                ${[...globalParties].sort().map(p => `
                    <div class="sim-input-box">
                        <span style="font-size:9px; color:#555">${p}</span>
                        <input type="number" placeholder="%" value="${(ep.similarity[p]||0)*100}" 
                               onchange="extraParties[${idx}].similarity['${p}']=parseFloat(this.value)/100">
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function addCoalition(){
    const name = $('coalName').value.trim().toUpperCase();
    if(!name) return;
    coalitions.push({ name, members:[] });
    renderCoalitions();
}

function renderCoalitions(){
    const all = [...globalParties, ...extraParties.map(e=>e.name)].sort();
    $('coalitionArea').innerHTML = coalitions.map((c, idx) => `
        <div class="data-row">
            <div class="flex-row"><b>${c.name}</b> <button class="danger" onclick="coalitions.splice(${idx},1);renderCoalitions();" style="width:25px; margin-left:auto">x</button></div>
            <div style="margin-top:8px">
                ${all.map(p => `
                    <label class="coal-member-label">
                        <input type="checkbox" ${c.members.includes(p)?'checked':''} 
                            onchange="const m=coalitions[${idx}].members; this.checked ? m.push('${p}') : coalitions[${idx}].members=m.filter(x=>x!=='${p}')">
                        ${p}
                    </label>
                `).join('')}
            </div>
        </div>
    `).join('');
}

// HESAPLAMA MOTORU (Fix: Katsayƒ± ve Patch Duyarlƒ±lƒ±ƒüƒ±)
$('runBtn').onclick = () => {
    if(!datasets.length) return alert("√ñnce veri y√ºkleyin!");

    // Katsayƒ±larƒ± (Weight) Inputlardan oku
    document.querySelectorAll('.ds-weight-input').forEach(inp => {
        const ds = datasets.find(x => x.id == inp.dataset.id);
        if(ds) ds.w = parseFloat(inp.value) || 0;
    });

    const targetNat = {};
    $('basePartiesArea').querySelectorAll('input').forEach(i => targetNat[i.dataset.p] = (parseFloat(i.value)||0)/100);

    const results = {};
    const masterDistrictNames = getMasterDistricts();

    masterDistrictNames.forEach(dName => {
        let seats = 0;
        for(let ds of datasets) {
            const match = getDistrictDataWithPatch(ds, dName);
            if(match && match.seats > 0) { seats = match.seats; break; }
        }

        if(seats === 0) return; // 0 MV olanlarƒ± hesaplama dƒ±≈üƒ± bƒ±rak

        const scoreMap = {};
        
        // Ana Partiler
        globalParties.forEach(p => {
            let pScore = 0, totalW = 0;
            datasets.forEach(ds => {
                const dData = getDistrictDataWithPatch(ds, dName);
                if(dData && dData.votes[p] > 0){
                    const dTotal = Object.values(dData.votes).reduce((a,b)=>a+b,0);
                    const perf = (dData.votes[p]/dTotal) / ds.nat[p];
                    pScore += perf * ds.w;
                    totalW += ds.w;
                }
            });
            scoreMap[p] = totalW > 0 ? (pScore/totalW) * targetNat[p] : 0;
        });

        // Yeni Partiler
        extraParties.forEach(ep => {
            let epScore = 0;
            for(let donor in ep.similarity){
                let dPerfSum = 0, dW = 0;
                datasets.forEach(ds => {
                    const dData = getDistrictDataWithPatch(ds, dName);
                    if(dData && dData.votes[donor] > 0){
                        const dTotal = Object.values(dData.votes).reduce((a,b)=>a+b,0);
                        dPerfSum += ((dData.votes[donor]/dTotal) / ds.nat[donor]) * ds.w;
                        dW += ds.w;
                    }
                });
                if(dW > 0) epScore += (dPerfSum/dW) * ep.similarity[donor];
            }
            scoreMap[ep.name] = epScore * (ep.nat/100);
        });

        const totalScore = Object.values(scoreMap).reduce((a,b)=>a+b,0);
        const finalVotes = {};
        for(let p in scoreMap) finalVotes[p] = (scoreMap[p]/(totalScore||1)) * 1000000;

        const dhondtInput = {...finalVotes};
        coalitions.forEach(c => {
            let cSum = 0;
            c.members.forEach(m => { cSum += (dhondtInput[m]||0); delete dhondtInput[m]; });
            dhondtInput[c.name] = cSum;
        });

        results[dName] = { 
            votes: finalVotes, 
            dhondt: dhondtInput, 
            mvs: runDhondt(dhondtInput, seats), 
            seats
        };
    });

    renderResults(results);
};

function runDhondt(v, s){
    const res = {}; Object.keys(v).forEach(p=>res[p]=0);
    for(let i=0; i<s; i++){
        let maxQ = -1, winP = null;
        for(let p in v){
            let q = v[p] / (res[p]+1);
            if(q > maxQ){ maxQ = q; winP = p; }
        }
        if(winP) res[winP]++;
    }
    return res;
}

function renderResults(res){
    const area = $('results');
    area.innerHTML = '';
    const sortedNames = Object.keys(res).sort();

    if(sortedNames.length === 0) {
        area.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px">MV koltuƒüu tanƒ±mlanmƒ±≈ü se√ßim √ßevresi bulunamadƒ±.</div>';
        return;
    }

    sortedNames.forEach(d => {
        const item = res[d];
        const card = document.createElement('div');
        card.className = 'dist-card';
        card.innerHTML = `<h3>${d} <span>${item.seats} MV</span></h3>`;
        
        Object.entries(item.dhondt).sort((a,b)=>b[1]-a[1]).forEach(([p, v])=> {
            if(v < 10) return;
            const isCoal = coalitions.find(c => c.name === p);
            const pct = ((v/1000000)*100).toFixed(2);
            const line = document.createElement('div');
            line.className = `p-line ${isCoal?'is-coal':''}`;
            line.innerHTML = `
                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:130px">${p}</span>
                <span style="white-space:nowrap">
                    <small style="color:#666">(%${pct})</small>
                    ${item.mvs[p] ? `<span class="mv-tag">${item.mvs[p]} MV</span>` : ''}
                </span>
            `;
            card.appendChild(line);
        });
        area.appendChild(card);
    });
}

function downloadResults(){
    let txt = "SECIM SIMULASYONU SONU√á RAPORU\n" + "=".repeat(40) + "\n\n";
    const cards = document.querySelectorAll('.dist-card');
    if(!cards.length) return alert("√ñnce hesaplama yapƒ±n!");
    cards.forEach(card => {
        txt += card.innerText.replace(/\n\n/g, '\n') + "\n" + "-".repeat(30) + "\n";
    });
    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'secim_sonuc_ozeti.txt';
    a.click();
}
</script>
</body>
</html>