<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Se√ßim Sim√ºlat√∂r√º Pro v5.6 - UI G√ºncellemesi</title>
    <style>
        :root{--primary:#0071e3;--bg:#f2f2f7;--card:#ffffff;--text:#1d1d1f;--border:#d2d2d7;--accent:#34c759;--danger:#ff3b30;--purple:#5856d6;--orange:#ff9500}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:15px;font-size:12px}
        
        .sidebar::-webkit-scrollbar { display: none; }
        .sidebar { -ms-overflow-style: none; scrollbar-width: none; }

        .container{max-width:1650px;margin:0 auto;display:grid;grid-template-columns:380px 1fr;gap:20px}
        h1{font-size:20px;font-weight:600;grid-column:1/-1;margin:0 0 15px; display:flex; align-items:center; gap:10px}
        .card{background:var(--card);border-radius:12px;padding:15px;box-shadow:0 1px 4px rgba(0,0,0,.05);border:1px solid var(--border);margin-bottom:15px}
        .sidebar{height:calc(100vh - 40px);overflow-y:auto;padding-right:5px}
        
        label{display:block;font-weight:600;margin-bottom:6px;color:#333}
        input, button, select{width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);margin-bottom:10px;box-sizing:border-box;font-size:12px}
        button{background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;transition:0.2s}
        button:hover{opacity:0.9}
        button.danger{background:var(--danger)}
        button.purple{background:var(--purple)}
        button.orange{background:var(--orange)}
        
        /* Yeni Toggle Butonu Stili */
        button.toggle-btn { background: transparent; border: 1px solid var(--border); color: #555; width: 30px; padding: 0; display: flex; align-items: center; justify-content: center; margin: 0; }
        button.toggle-btn:hover { background: #f0f0f0; }

        .data-row{background:#f9f9f9;padding:10px;border-radius:8px;margin-bottom:8px;border:1px solid #eee}
        .parties-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(85px, 1fr));gap:6px}
        .party-box{background:#fff;border:1px solid var(--border);padding:6px;border-radius:6px;text-align:center}
        
        .similarity-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(110px, 1fr));gap:8px;margin-top:10px}
        .sim-input-box{background:#eff4f9;padding:8px;border-radius:6px;border:1px solid #d1d9e0}

        #results{display:grid;grid-template-columns:repeat(auto-fill, minmax(calc(25% - 15px), 1fr));gap:15px}
        .dist-card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);border-top:4px solid var(--primary)}
        .dist-card h3{margin:0 0 10px;font-size:13px;display:flex;justify-content:space-between;color:var(--primary)}
        
        .p-line{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f0f0f0;align-items:center}
        .p-line.is-coal{color:var(--primary);font-weight:bold;background:#f0f7ff;margin:2px -5px;padding:5px;border-radius:4px}
        .mv-tag{background:var(--text);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:bold;margin-left:5px}
        
        .coal-member-label { display: flex; align-items: center; gap: 8px; font-weight: 400; margin-bottom: 5px; cursor: pointer; padding: 2px 0;}
        .coal-member-label input { width: 16px; height: 16px; margin: 0; cursor: pointer; }

        .flex-row{display:flex;gap:8px;align-items:center}
        .scroll-area{max-height:250px;overflow-y:auto;padding-right:5px; border:1px solid #eee; border-radius:8px; padding:5px; background:#fafafa}
    </style>
</head>
<body>

<h1>üó≥Ô∏è Se√ßim Sim√ºlat√∂r√º Pro v5.6 <small style="font-weight:400; font-size:12px; color:#666">| Geni≈ületilebilir Aray√ºz</small></h1>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <label>1. Veri Setleri (.txt)</label>
            <input type="file" id="fileInp" accept=".txt" multiple>
            <div id="datasetsList" class="scroll-area"></div>
        </div>

        <div class="card">
            <label>2. Hedef √úlke Oy Oranlarƒ± (%)</label>
            <div id="basePartiesArea" class="parties-grid"></div>
        </div>

        <div class="card">
            <label>3. Yeni Parti Ekle</label>
            <div class="flex-row">
                <input id="newPName" placeholder="Ad">
                <input id="newPNat" type="number" placeholder="%" style="width:70px">
                <button onclick="addExtraParty()" style="width:50px">+</button>
            </div>
            <div id="extraPartiesArea"></div>
        </div>

        <div class="card">
            <label>4. Ortak Listeler (ƒ∞ttifak)</label>
            <div class="flex-row">
                <input id="coalName" placeholder="Liste Adƒ±">
                <button onclick="addCoalition()" style="width:50px">+</button>
            </div>
            <div id="coalitionArea" class="scroll-area"></div>
        </div>

        <div class="card" style="position: sticky; bottom: 0; background: #fff; z-index: 10; padding-top: 10px; border-top: 2px solid var(--primary);">
            <button id="runBtn" style="background:var(--accent); font-size:15px; padding:16px; margin-bottom:10px">üöÄ HESAPLA</button>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px">
                <button onclick="saveProject()" class="purple">üìÅ PROJEYƒ∞ KAYDET (.JSON)</button>
                <button onclick="$('projectLoader').click()" class="orange">üìÇ PROJE Y√úKLE (.JSON)</button>
            </div>
            <input type="file" id="projectLoader" accept=".json" style="display:none" onchange="loadProject(this)">
            
            <button onclick="downloadResults()" class="danger" style="margin-top:5px">üíæ SONU√áLARI ƒ∞NDƒ∞R (.TXT)</button>
        </div>
    </div>

    <div id="results">
        <div style="grid-column:1/-1; color:#888; text-align:center; padding:100px; font-size:14px">
            Se√ßim sonu√ßlarƒ±nƒ± g√∂rmek i√ßin veri setlerini y√ºkleyin veya hazƒ±r proje dosyasƒ± (.json) a√ßƒ±n.
        </div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let datasets = [];
let extraParties = [];
let coalitions = [];
let globalParties = new Set();
let globalResults = {}; 

// Veri Okuma ve Ayrƒ±≈ütƒ±rma
$('fileInp').onchange = async (e) => {
    for(let file of e.target.files){
        const text = await file.text();
        const data = parseTxt(text);
        const nat = calcNat(data);
        datasets.push({ id:Date.now()+Math.random(), name:file.name, data, nat, w:1.0 });
    }
    updateGlobalParties();
    renderDatasets();
};

function parseTxt(t){
    const out = {};
    t.split(/\n-\s*\n|\n\n+/).forEach(block => {
        const lines = block.trim().split('\n');
        if(lines.length < 2) return;
        
        let header = lines[0].trim();
        let parts = header.split('-');
        let seats = parseInt(parts.pop()) || 0;
        let name = parts.join('-').trim().toUpperCase();
        
        const votes = {};
        lines.slice(1).forEach(l => {
            const p = l.split(/\s+/);
            const v = parseInt(p.pop().replace(/\D/g,''));
            if(!isNaN(v)) votes[p.join(' ').toUpperCase()] = v;
        });
        out[name] = { votes, seats };
    });
    return out;
}

function calcNat(data){
    let total = 0, sums = {};
    for(let d in data){
        for(let p in data[d].votes){
            sums[p] = (sums[p]||0) + data[d].votes[p];
            total += data[d].votes[p];
        }
    }
    for(let p in sums) sums[p] /= (total || 1);
    return sums;
}

function getMasterDistricts() {
    const allDNames = new Set();
    datasets.forEach(ds => {
        Object.keys(ds.data).forEach(n => {
            if(ds.data[n].seats > 0) allDNames.add(n);
        });
    });
    const names = Array.from(allDNames);
    const parentsWithChildren = new Set();
    names.forEach(n => {
        if(n.includes('-')) {
            const parentName = n.split('-')[0].trim();
            parentsWithChildren.add(parentName);
        }
    });
    return names.filter(n => !parentsWithChildren.has(n));
}

function getDistrictDataWithPatch(dataset, targetName) {
    if(dataset.data[targetName]) return dataset.data[targetName];
    const root = targetName.split('-')[0].trim();
    if(dataset.data[root]) return dataset.data[root];
    return null;
}

function updateGlobalParties(){
    globalParties = new Set(); 
    datasets.forEach(ds => Object.keys(ds.nat).forEach(p => globalParties.add(p)));
    renderBaseInputs();
}

function renderDatasets(){
    $('datasetsList').innerHTML = datasets.map(ds => `
        <div class="data-row flex-row">
            <span style="flex:1; overflow:hidden; font-size:11px"><b>${ds.name}</b></span>
            <div style="display:flex; align-items:center; gap:3px">
                W:<input type="number" step="0.1" value="${ds.w}" class="ds-weight-input" data-id="${ds.id}" style="width:40px; margin:0">
            </div>
            <button class="danger" onclick="datasets=datasets.filter(x=>x.id!=${ds.id});renderDatasets();updateGlobalParties();" style="width:22px; margin:0; padding:2px">x</button>
        </div>
    `).join('');
}

function renderBaseInputs(){
    const area = $('basePartiesArea');
    const oldVals = {}; 
    area.querySelectorAll('input').forEach(i => oldVals[i.dataset.p] = i.value);
    area.innerHTML = [...globalParties].sort().map(p => `
        <div class="party-box">
            <span>${p}</span>
            <input data-p="${p}" type="number" step="0.1" value="${oldVals[p]||0}">
        </div>
    `).join('');
}

function addExtraParty(){
    const name = $('newPName').value.trim().toUpperCase();
    const nat = parseFloat($('newPNat').value)||0;
    if(!name) return;
    // isOpen: true default olarak a√ßƒ±k gelir
    extraParties.push({ name, nat, similarity:{}, isOpen: true });
    $('newPName').value = '';
    $('newPNat').value = '';
    renderExtraParties();
}

function toggleExtraParty(idx) {
    extraParties[idx].isOpen = !extraParties[idx].isOpen;
    renderExtraParties();
}

function renderExtraParties(){
    $('extraPartiesArea').innerHTML = extraParties.map((ep, idx) => `
        <div class="data-row">
            <div class="flex-row">
                <button class="toggle-btn" onclick="toggleExtraParty(${idx})">${ep.isOpen ? '‚ñ≤' : '‚ñº'}</button>
                <b style="width:80px; overflow:hidden; text-overflow:ellipsis;">${ep.name}</b> 
                <input type="number" step="0.1" value="${ep.nat}" style="width:60px; margin:0; font-weight:bold" 
                       onchange="extraParties[${idx}].nat = parseFloat(this.value)||0">
                <span>%</span>
                <button class="danger" onclick="extraParties.splice(${idx},1);renderExtraParties();" style="width:25px; margin-left:auto">x</button>
            </div>
            <div class="similarity-grid" style="display: ${ep.isOpen ? 'grid' : 'none'}">
                ${[...globalParties].sort().map(p => `
                    <div class="sim-input-box">
                        <span style="font-size:9px; color:#555">${p}</span>
                        <input type="number" placeholder="%" value="${(ep.similarity[p]||0)*100}" 
                               onchange="extraParties[${idx}].similarity['${p}']=parseFloat(this.value)/100">
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

function addCoalition(){
    const name = $('coalName').value.trim().toUpperCase();
    if(!name) return;
    // isOpen: true default olarak a√ßƒ±k gelir
    coalitions.push({ name, members:[], isOpen: true });
    $('coalName').value = ''; 
    renderCoalitions();
}

function toggleCoalition(idx) {
    coalitions[idx].isOpen = !coalitions[idx].isOpen;
    renderCoalitions();
}

function renderCoalitions(){
    const all = [...globalParties, ...extraParties.map(e=>e.name)].sort();
    $('coalitionArea').innerHTML = coalitions.map((c, idx) => `
        <div class="data-row">
            <div class="flex-row">
                <button class="toggle-btn" onclick="toggleCoalition(${idx})">${c.isOpen ? '‚ñ≤' : '‚ñº'}</button>
                <b>${c.name}</b> 
                <button class="danger" onclick="coalitions.splice(${idx},1);renderCoalitions();" style="width:25px; margin-left:auto">x</button>
            </div>
            <div style="margin-top:8px; display: ${c.isOpen ? 'block' : 'none'}">
                ${all.map(p => `
                    <label class="coal-member-label">
                        <input type="checkbox" ${c.members.includes(p)?'checked':''} 
                            onchange="const m=coalitions[${idx}].members; this.checked ? m.push('${p}') : coalitions[${idx}].members=m.filter(x=>x!=='${p}')">
                        ${p}
                    </label>
                `).join('')}
            </div>
        </div>
    `).join('');
}

// === PROJE KAYDETME VE Y√úKLEME FONKSƒ∞YONLARI ===

function saveProject() {
    const currentTargets = {};
    $('basePartiesArea').querySelectorAll('input').forEach(i => {
        currentTargets[i.dataset.p] = parseFloat(i.value) || 0;
    });

    const projectData = {
        meta: { version: "5.6", date: new Date().toISOString() },
        datasets: datasets,
        extraParties: extraParties,
        coalitions: coalitions,
        targets: currentTargets
    };

    const jsonStr = JSON.stringify(projectData, null, 2);
    const blob = new Blob([jsonStr], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'secim_projesi_' + new Date().toISOString().slice(0,10) + '.json';
    a.click();
}

async function loadProject(inp) {
    const file = inp.files[0];
    if(!file) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        if(!data.datasets) throw new Error("Ge√ßersiz proje dosyasƒ±");

        datasets = data.datasets || [];
        
        // Geriye d√∂n√ºk uyumluluk: Eƒüer eski bir proje ise isOpen √∂zelliƒüi yoktur, true atayalƒ±m.
        extraParties = (data.extraParties || []).map(ep => ({...ep, isOpen: (ep.isOpen !== undefined ? ep.isOpen : true)}));
        coalitions = (data.coalitions || []).map(c => ({...c, isOpen: (c.isOpen !== undefined ? c.isOpen : true)}));

        updateGlobalParties(); 
        renderDatasets();
        renderExtraParties();
        renderCoalitions();

        if(data.targets) {
            const inputs = $('basePartiesArea').querySelectorAll('input');
            inputs.forEach(i => {
                if(data.targets[i.dataset.p] !== undefined) {
                    i.value = data.targets[i.dataset.p];
                }
            });
        }

        alert("Proje ba≈üarƒ±yla y√ºklendi!");
        $('fileInp').value = ''; 
        inp.value = '';

    } catch(err) {
        alert("Proje y√ºklenirken hata olu≈ütu: " + err.message);
    }
}

// === HESAPLAMA MOTORU ===
$('runBtn').onclick = () => {
    if(!datasets.length) return alert("√ñnce veri y√ºkleyin!");

    document.querySelectorAll('.ds-weight-input').forEach(inp => {
        const ds = datasets.find(x => x.id == inp.dataset.id);
        if(ds) ds.w = parseFloat(inp.value) || 0;
    });

    const targetNat = {};
    $('basePartiesArea').querySelectorAll('input').forEach(i => targetNat[i.dataset.p] = (parseFloat(i.value)||0)/100);

    globalResults = {}; 
    const masterDistrictNames = getMasterDistricts();

    masterDistrictNames.forEach(dName => {
        let seats = 0;
        for(let ds of datasets) {
            const match = getDistrictDataWithPatch(ds, dName);
            if(match && match.seats > 0) { seats = match.seats; break; }
        }

        if(seats === 0) return; 

        const scoreMap = {};
        
        globalParties.forEach(p => {
            let pScore = 0, totalW = 0;
            datasets.forEach(ds => {
                const dData = getDistrictDataWithPatch(ds, dName);
                if(dData && dData.votes[p] > 0){
                    const dTotal = Object.values(dData.votes).reduce((a,b)=>a+b,0);
                    const perf = (dData.votes[p]/dTotal) / ds.nat[p];
                    pScore += perf * ds.w;
                    totalW += ds.w;
                }
            });
            scoreMap[p] = totalW > 0 ? (pScore/totalW) * targetNat[p] : 0;
        });

        extraParties.forEach(ep => {
            let epScore = 0;
            let hasSimilarity = Object.keys(ep.similarity).length > 0;
            
            if(!hasSimilarity) {
                epScore = 1.0; 
            } else {
                for(let donor in ep.similarity){
                    let dPerfSum = 0, dW = 0;
                    datasets.forEach(ds => {
                        const dData = getDistrictDataWithPatch(ds, dName);
                        if(dData && dData.votes[donor] > 0){
                            const dTotal = Object.values(dData.votes).reduce((a,b)=>a+b,0);
                            dPerfSum += ((dData.votes[donor]/dTotal) / ds.nat[donor]) * ds.w;
                            dW += ds.w;
                        }
                    });
                    if(dW > 0) epScore += (dPerfSum/dW) * ep.similarity[donor];
                }
            }
            scoreMap[ep.name] = epScore * (ep.nat/100);
        });

        const totalScore = Object.values(scoreMap).reduce((a,b)=>a+b,0);
        const finalVotes = {};
        for(let p in scoreMap) finalVotes[p] = (scoreMap[p]/(totalScore||1)) * 1000000;

        const dhondtInput = {...finalVotes};
        
        coalitions.forEach(c => {
            let cSum = 0;
            c.members.forEach(m => { 
                if(dhondtInput[m]) {
                    cSum += dhondtInput[m]; 
                    delete dhondtInput[m]; 
                }
            });
            if(cSum > 0) dhondtInput[c.name] = cSum;
        });

        const coalitionSeats = runDhondt(dhondtInput, seats);
        const finalSeats = {};
        Object.keys(coalitionSeats).forEach(winner => {
            const coal = coalitions.find(c => c.name === winner);
            if(coal) {
                const subVotes = {};
                coal.members.forEach(m => subVotes[m] = finalVotes[m] || 0);
                const subSeats = runDhondt(subVotes, coalitionSeats[winner]);
                Object.assign(finalSeats, subSeats);
            } else {
                finalSeats[winner] = coalitionSeats[winner];
            }
        });
        
        globalResults[dName] = { 
            votes: finalVotes,
            dhondt: dhondtInput,
            mvs: finalSeats,
            seats
        };
    });

    renderResults(globalResults);
};

function runDhondt(v, s){
    const res = {}; Object.keys(v).forEach(p=>res[p]=0);
    for(let i=0; i<s; i++){
        let maxQ = -1, winP = null;
        for(let p in v){
            let q = v[p] / (res[p]+1);
            if(q > maxQ){ maxQ = q; winP = p; }
        }
        if(winP) res[winP]++;
    }
    return res;
}

function renderResults(res){
    const area = $('results');
    area.innerHTML = '';
    const sortedNames = Object.keys(res).sort();

    if(sortedNames.length === 0) {
        area.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px">MV koltuƒüu tanƒ±mlanmƒ±≈ü se√ßim √ßevresi bulunamadƒ±.</div>';
        return;
    }

    sortedNames.forEach(d => {
        const item = res[d];
        const card = document.createElement('div');
        card.className = 'dist-card';
        card.innerHTML = `<h3>${d} <span>${item.seats} MV</span></h3>`;
        
        Object.entries(item.dhondt).sort((a,b)=>b[1]-a[1]).forEach(([p, v])=> {
            if(v < 10) return;
            
            const isCoal = coalitions.find(c => c.name === p);
            const pct = ((v/1000000)*100).toFixed(2);
            let totalMv = 0;

            if(isCoal) {
                isCoal.members.forEach(m => totalMv += (item.mvs[m]||0));
            } else {
                totalMv = item.mvs[p] || 0;
            }

            const line = document.createElement('div');
            line.className = `p-line ${isCoal?'is-coal':''}`;
            line.innerHTML = `
                <div style="display:flex; flex-direction:column; justify-content:center">
                    <span style="font-weight:600; font-size:11px">${p}</span>
                    ${isCoal ? `<span style="font-size:9px; font-weight:normal">${isCoal.members.map(m=> m + (item.mvs[m]>0 ? ` (${item.mvs[m]})` : '')).join(', ')}</span>` : ''}
                </div>
                <div style="text-align:right">
                    <small style="color:#666; font-size:10px">%${pct}</small>
                    ${totalMv > 0 ? `<span class="mv-tag">${totalMv} MV</span>` : ''}
                </div>
            `;
            card.appendChild(line);
        });
        area.appendChild(card);
    });
}

function downloadResults(){
    if(Object.keys(globalResults).length === 0) return alert("√ñnce hesaplama yapƒ±n!");

    let txt = "";
    const sortedDistricts = Object.keys(globalResults).sort();

    sortedDistricts.forEach(dName => {
        const item = globalResults[dName];
        txt += `${dName}-${item.seats}\n`;
        Object.entries(item.dhondt).forEach(([party, count]) => {
            txt += `${party} ${Math.floor(count)}\n`;
        });
        txt += "-\n";
    });

    const blob = new Blob([txt], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'simulasyon_sonucu_ortak_liste.txt';
    a.click();
}
</script>
</body>
</html>